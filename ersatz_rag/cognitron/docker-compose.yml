version: '3.8'

# Cognitron Medical-Grade Personal Knowledge Assistant
# Production-ready Docker Compose configuration with monitoring and security

services:
  # ==========================================================================
  # Cognitron Main Application
  # ==========================================================================
  cognitron:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
      args:
        COGNITRON_VERSION: "1.0.0"
        BUILD_DATE: "${BUILD_DATE:-$(date -u +'%Y-%m-%dT%H:%M:%SZ')}"
        VCS_REF: "${VCS_REF:-$(git rev-parse --short HEAD)}"
    
    image: cognitron/cognitron:latest
    container_name: cognitron-app
    hostname: cognitron-app
    restart: unless-stopped
    
    # Network configuration
    networks:
      - cognitron-network
    
    # Port mappings
    ports:
      - "8080:8080"    # Main application
      - "9090:9090"    # Prometheus metrics
    
    # Volume mounts for persistence and configuration
    volumes:
      # Persistent data storage
      - cognitron-data:/app/data
      - cognitron-logs:/app/logs
      
      # Configuration files (read-only)
      - ./config/production.yaml:/app/config/production.yaml:ro
      - ./config/medical-grade.yaml:/app/config/medical-grade.yaml:ro
      
      # Knowledge base (read-only for indexing)
      - ${KNOWLEDGE_BASE_PATH:-./knowledge}:/app/knowledge:ro
      
      # SSL certificates (if using HTTPS)
      - ${SSL_CERT_PATH:-./certs}:/app/certs:ro
    
    # Environment variables for medical-grade configuration
    environment:
      # Application settings
      - COGNITRON_ENV=production
      - COGNITRON_VERSION=1.0.0
      
      # Medical-grade thresholds
      - COGNITRON_CRITICAL_THRESHOLD=${CRITICAL_THRESHOLD:-0.95}
      - COGNITRON_PRODUCTION_THRESHOLD=${PRODUCTION_THRESHOLD:-0.85}
      - COGNITRON_DISPLAY_THRESHOLD=${DISPLAY_THRESHOLD:-0.70}
      
      # Security and privacy
      - COGNITRON_SECURITY_LEVEL=medical_grade
      - COGNITRON_AUDIT_ENABLED=true
      - COGNITRON_ENCRYPT_STORAGE=true
      - COGNITRON_LOCAL_PROCESSING_ONLY=true
      
      # Logging configuration
      - COGNITRON_LOG_LEVEL=${LOG_LEVEL:-INFO}
      - COGNITRON_LOG_FORMAT=json
      - COGNITRON_AUDIT_LOG_RETENTION=90
      
      # Performance tuning
      - COGNITRON_MAX_WORKERS=${MAX_WORKERS:-4}
      - COGNITRON_MAX_MEMORY=${MAX_MEMORY:-2G}
      - COGNITRON_CACHE_SIZE=${CACHE_SIZE:-512M}
      
      # Monitoring
      - COGNITRON_METRICS_ENABLED=true
      - COGNITRON_HEALTH_CHECK_ENABLED=true
      - COGNITRON_TRACING_ENABLED=${TRACING_ENABLED:-false}
      
      # API Keys (use .env file for security)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
    
    # Resource limits for medical-grade reliability
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-2G}
          cpus: '${CPU_LIMIT:-1.0}'
        reservations:
          memory: ${MEMORY_RESERVATION:-1G}
          cpus: '${CPU_RESERVATION:-0.5}'
    
    # Health checks
    healthcheck:
      test: ["CMD", "python", "/app/healthcheck.py"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    
    # Security configuration
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default
    
    # Read-only root filesystem for security
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /var/tmp:noexec,nosuid,size=50m
    
    # Dependencies
    depends_on:
      redis:
        condition: service_healthy
      prometheus:
        condition: service_started

  # ==========================================================================
  # Redis - Caching and Session Storage
  # ==========================================================================
  redis:
    image: redis:7.2-alpine
    container_name: cognitron-redis
    hostname: cognitron-redis
    restart: unless-stopped
    
    # Network configuration
    networks:
      - cognitron-network
    
    # Redis configuration
    command: redis-server /usr/local/etc/redis/redis.conf
    
    # Volume for Redis configuration and persistence
    volumes:
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
      - redis-data:/data
    
    # Environment variables
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-cognitron-secure-2024}
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    
    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD:-cognitron-secure-2024}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    
    # Security
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  # Prometheus - Metrics Collection
  # ==========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: cognitron-prometheus
    hostname: cognitron-prometheus
    restart: unless-stopped
    
    # Network configuration
    networks:
      - cognitron-network
      - monitoring-network
    
    # Port mapping
    ports:
      - "9091:9090"
    
    # Configuration and data volumes
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/rules/:/etc/prometheus/rules/:ro
      - prometheus-data:/prometheus
    
    # Command line arguments
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=90d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    
    # Security
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  # Grafana - Monitoring Dashboard
  # ==========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: cognitron-grafana
    hostname: cognitron-grafana
    restart: unless-stopped
    
    # Network configuration
    networks:
      - monitoring-network
    
    # Port mapping
    ports:
      - "3000:3000"
    
    # Environment variables
    environment:
      # Security settings
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-cognitron-admin-2024}
      - GF_SECURITY_SECRET_KEY=${GRAFANA_SECRET_KEY:-cognitron-grafana-secret-2024}
      
      # Disable user signup
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_USERS_ALLOW_ORG_CREATE=false
      
      # Anonymous access (disabled)
      - GF_AUTH_ANONYMOUS_ENABLED=false
      
      # Logging
      - GF_LOG_LEVEL=info
      - GF_LOG_MODE=console
      
      # Database (using default SQLite)
      - GF_DATABASE_TYPE=sqlite3
      - GF_DATABASE_PATH=/var/lib/grafana/grafana.db
      
      # Install plugins
      - GF_INSTALL_PLUGINS=grafana-clock-panel,grafana-simple-json-datasource
    
    # Volumes
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/datasources:/etc/grafana/provisioning/datasources:ro
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    
    # Dependencies
    depends_on:
      prometheus:
        condition: service_started
    
    # Security
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  # AlertManager - Alert Management
  # ==========================================================================
  alertmanager:
    image: prom/alertmanager:latest
    container_name: cognitron-alertmanager
    hostname: cognitron-alertmanager
    restart: unless-stopped
    
    # Network configuration
    networks:
      - monitoring-network
    
    # Port mapping
    ports:
      - "9093:9093"
    
    # Configuration volume
    volumes:
      - ./monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    
    # Command line arguments
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.125'
    
    # Security
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  # Node Exporter - System Metrics
  # ==========================================================================
  node-exporter:
    image: prom/node-exporter:latest
    container_name: cognitron-node-exporter
    hostname: cognitron-node-exporter
    restart: unless-stopped
    
    # Network configuration
    networks:
      - monitoring-network
    
    # Host network for system metrics
    network_mode: host
    pid: host
    
    # Volumes for system access
    volumes:
      - '/:/host:ro,rslave'
    
    # Command line arguments
    command:
      - '--path.rootfs=/host'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc|rootfs/var/lib/docker/containers|rootfs/var/lib/docker/overlay2|rootfs/run/docker/netns|rootfs/var/lib/docker/aufs)($$|/)'
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.125'
    
    # Security
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  # Loki - Log Aggregation
  # ==========================================================================
  loki:
    image: grafana/loki:latest
    container_name: cognitron-loki
    hostname: cognitron-loki
    restart: unless-stopped
    
    # Network configuration
    networks:
      - monitoring-network
    
    # Port mapping
    ports:
      - "3100:3100"
    
    # Configuration and data volumes
    volumes:
      - ./monitoring/loki.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    
    # Command
    command: -config.file=/etc/loki/local-config.yaml
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    
    # Security
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  # Promtail - Log Shipper
  # ==========================================================================
  promtail:
    image: grafana/promtail:latest
    container_name: cognitron-promtail
    hostname: cognitron-promtail
    restart: unless-stopped
    
    # Network configuration
    networks:
      - monitoring-network
    
    # Configuration volume
    volumes:
      - ./monitoring/promtail.yml:/etc/promtail/config.yml:ro
      - cognitron-logs:/var/log/cognitron:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    
    # Command
    command: -config.file=/etc/promtail/config.yml
    
    # Dependencies
    depends_on:
      loki:
        condition: service_started
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.125'
    
    # Security
    security_opt:
      - no-new-privileges:true

  # ==========================================================================
  # Nginx - Reverse Proxy and Load Balancer
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: cognitron-nginx
    hostname: cognitron-nginx
    restart: unless-stopped
    
    # Network configuration
    networks:
      - cognitron-network
    
    # Port mappings
    ports:
      - "80:80"
      - "443:443"
    
    # Configuration and SSL certificates
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
      - ${SSL_CERT_PATH:-./certs}:/etc/nginx/certs:ro
      - nginx-logs:/var/log/nginx
    
    # Dependencies
    depends_on:
      cognitron:
        condition: service_healthy
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.125'
    
    # Security
    security_opt:
      - no-new-privileges:true

# =============================================================================
# Network Configuration
# =============================================================================
networks:
  cognitron-network:
    driver: bridge
    name: cognitron-network
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: cognitron0
      com.docker.network.bridge.enable_icc: "true"
      com.docker.network.bridge.enable_ip_masquerade: "true"
  
  monitoring-network:
    driver: bridge
    name: monitoring-network
    ipam:
      driver: default
      config:
        - subnet: 172.21.0.0/16
          gateway: 172.21.0.1

# =============================================================================
# Volume Configuration
# =============================================================================
volumes:
  # Application data volumes
  cognitron-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}
  
  cognitron-logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LOGS_PATH:-./logs}
  
  # Database volumes
  redis-data:
    driver: local
    name: cognitron-redis-data
  
  # Monitoring volumes
  prometheus-data:
    driver: local
    name: cognitron-prometheus-data
  
  grafana-data:
    driver: local
    name: cognitron-grafana-data
  
  alertmanager-data:
    driver: local
    name: cognitron-alertmanager-data
  
  loki-data:
    driver: local
    name: cognitron-loki-data
  
  # Web server logs
  nginx-logs:
    driver: local
    name: cognitron-nginx-logs

# =============================================================================
# Additional Configuration Notes
# =============================================================================

# To run this configuration:
# 1. Copy docker-compose.yml to your deployment directory
# 2. Create .env file with required environment variables
# 3. Create configuration directories: config/, monitoring/, certs/
# 4. Run: docker-compose up -d
# 5. Access Cognitron at http://localhost (or https with SSL)
# 6. Monitor via Grafana at http://localhost:3000
# 7. View metrics at http://localhost:9091 (Prometheus)

# For production deployment:
# 1. Set strong passwords in .env file
# 2. Configure SSL certificates in certs/ directory
# 3. Adjust resource limits based on your hardware
# 4. Configure external secrets management
# 5. Set up backup strategy for persistent volumes
# 6. Configure log rotation and archival
# 7. Implement disaster recovery procedures